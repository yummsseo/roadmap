<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>ROU ë§ì¶¤í˜• ê²½ë¡œ ì›¹</title>
    <style>
        /* ì§€ë„ë¥¼ í™”ë©´ì— ê½‰ ì°¨ê²Œ ì„¤ì •í•˜ëŠ” í•„ìˆ˜ CSS */
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; }
        #map_div { width: 100%; height: 100%; }
        
        /* ì •ë³´ í‘œì‹œ ì°½ ìŠ¤íƒ€ì¼ */
        #info {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: white; padding: 10px; border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            font-size: 14px;
        }
        #info button { margin-top: 5px; cursor: pointer; }
    </style>
</head>
<body onload="initTmap()"> 
    
    <div id="info">
        <b>[ê²½ë¡œ ê²€ìƒ‰]</b>
        <p>ì¶œë°œì§€: <input type="text" id="start_input" value="{{ start_key }}" placeholder="ì¶œë°œ ì¥ì†Œ ì´ë¦„ ë˜ëŠ” ì£¼ì†Œ"></p>
        <p>ë„ì°©ì§€: <input type="text" id="end_input" value="{{ end_key }}" placeholder="ë„ì°© ì¥ì†Œ ì´ë¦„ ë˜ëŠ” ì£¼ì†Œ"></p>
        <div id="info_text">í‚¤ì›Œë“œë¥¼ ì…ë ¥ í›„ 'ê²½ë¡œ ì°¾ê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
        <button onclick="findPathFromInput()">ê²½ë¡œ ì°¾ê¸°</button>
        <button onclick="resetMap()">ì§€ë„ ì´ˆê¸°í™”</button>
    </div>

    <div id="map_div"></div>

    <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=HRfwcjIwBt78mOxVBBGYH6MSQKPcv7SzadLC0GXh"></script>
    
    <script>
        // --- CSRF í† í°ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (Django POST ìš”ì²­ì— í•„ìˆ˜) ---
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');


        var map;
        var startMarker, endMarker;
        var polyline;
        var obstacleMarkers = []; 
        
        // ğŸ¯ ì¶œë°œì§€ SVG ë§ˆì»¤ ìƒì„± (í¬ê³  ì§„í•œ ì´ˆë¡ìƒ‰ í•€ + 'ì¶œ' ê¸€ì)
        function createStartMarkerIcon() {
            var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="50" height="60" viewBox="0 0 50 60">' +
              '<ellipse cx="25" cy="57" rx="8" ry="3" fill="rgba(0,0,0,0.3)"/>' +
              '<path d="M25 5 C15 5 7 13 7 23 C7 38 25 55 25 55 S43 38 43 23 C43 13 35 5 25 5 Z" ' +
              'fill="#2E7D32" stroke="white" stroke-width="3"/>' +
              '<circle cx="25" cy="23" r="12" fill="white"/>' +
              '<circle cx="25" cy="23" r="12" fill="none" stroke="#2E7D32" stroke-width="2"/>' +
              // 'ì¶œ' ê¸€ì (í¬ê³  êµµê²Œ)
              '<text x="25" y="30" font-size="18" font-weight="bold" text-anchor="middle" fill="#2E7D32">ì¶œ</text>' +
              '</svg>';
        return "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg);
        }

        // ğŸ¯ ë„ì°©ì§€ SVG ë§ˆì»¤ ìƒì„± (í¬ê³  ì§„í•œ ë¹¨ê°„ìƒ‰ í•€ + 'ë„' ê¸€ì)
        function createEndMarkerIcon() {
        var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="50" height="60" viewBox="0 0 50 60">' +
              '<ellipse cx="25" cy="57" rx="8" ry="3" fill="rgba(0,0,0,0.3)"/>' +
              '<path d="M25 5 C15 5 7 13 7 23 C7 38 25 55 25 55 S43 38 43 23 C43 13 35 5 25 5 Z" ' +
              'fill="#D32F2F" stroke="white" stroke-width="3"/>' +
              '<circle cx="25" cy="23" r="12" fill="white"/>' +
              '<circle cx="25" cy="23" r="12" fill="none" stroke="#D32F2F" stroke-width="2"/>' +
              // 'ë„' ê¸€ì (í¬ê³  êµµê²Œ)
              '<text x="25" y="30" font-size="18" font-weight="bold" text-anchor="middle" fill="#D32F2F">ë„</text>' +
              '</svg>';
        return "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg);
        }
        
        // ğŸŒŸ ROU-3/4: ì¥ì• ë¬¼ ì¢…ë¥˜ì— ë”°ë¼ ì´ëª¨í‹°ì½˜ì„ ê²°ì •í•˜ëŠ” í•¨ìˆ˜ (ìµœì¢… ìˆ˜ì •) ğŸŒŸ
        function getMarkerEmoji(typeDescription) {
            var text = typeDescription || '';
            
            if (text.includes('ê³„ë‹¨')) { return 'ğŸªœ'; } 
            // else if(text.includes('ì¶œêµ¬') || text.includes('ì¸µ')) {return 'ğŸ”š'}
            else if (text.includes('ìœ¡êµ') || text.includes('ë‹¤ë¦¬') || text.includes('ê³ ê°€')) { return 'ğŸŒ‰'; } 
            else if (text.includes('íš¡ë‹¨ë³´ë„') || text.includes('ê±´ë„ëª©')) { return 'ğŸš¦'; }
            else if (text.includes('ê²½ì‚¬ë¡œ') || text.includes('ë¨í”„')) { return 'â™¿'; } 
            else if (text.includes('ì—˜ë¦¬ë² ì´í„°') || text.includes('ìŠ¹ê°•ê¸°') || text.includes('ì—ìŠ¤ì»¬ë ˆì´í„°')) { return 'ğŸ›—'; }
            else if (text.includes('ì¢ŒíšŒì „'))  {return 'â¬…ï¸'} 
            else if (text.includes('ìš°íšŒì „')) {return 'â¡ï¸'}
            else if (text.includes('ì§ì§„')) { return 'â¬†ï¸'; } 
            
            return 'ğŸ“'; 
        }

        function createEmojiIcon(emoji, bgColor) {
            return "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(
                '<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">' +
                '<circle cx="20" cy="20" r="18" fill="' + bgColor + '" stroke="white" stroke-width="2"/>' +
                '<text x="20" y="28" font-size="20" text-anchor="middle" font-family="Arial">' + emoji + '</text>' +
                '</svg>'
            );
        }

        // ğŸŒŸ ë§ˆì»¤ ìƒ‰ìƒ ê²°ì • í•¨ìˆ˜ (ìµœì¢… ìˆ˜ì •) ğŸŒŸ
        function getMarkerColor(typeDescription) {
            var text = typeDescription || '';
            
            if (text.includes('ê³„ë‹¨') || text.includes('ìœ¡êµ')) { return '#FF4444'; } // ë¹¨ê°„ìƒ‰ (ìœ„í—˜)
            else if (text.includes('íš¡ë‹¨ë³´ë„')) { return '#FF8800'; } // ì£¼í™©ìƒ‰
            else if (text.includes('ê²½ì‚¬ë¡œ') || text.includes('ì—˜ë¦¬ë² ì´í„°')) { return '#4444FF'; } // íŒŒë€ìƒ‰ (í¸ì˜ì‹œì„¤)
            else if (text.includes('íšŒì „') || text.includes('ì§ì§„')) { return '#44AA44'; } // ì´ˆë¡ìƒ‰ (ì•ˆë‚´)
            
            return '#888888'; // íšŒìƒ‰
        }
        // --- SVG/Emoji í•¨ìˆ˜ ë ---


        function initTmap() {
            // 1. ì§€ë„ ìƒì„± (ì´ˆê¸° ì¤‘ì‹¬ì€ ì„œìš¸ì‹œì²­ ë¶€ê·¼)
            map = new Tmapv2.Map("map_div", {
                center: new Tmapv2.LatLng(37.566535, 126.9779692),
                width: "100%", height: "100%", zoom: 15
            });
        }
        
        // --- ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜ (ë§ˆì»¤ ë³€ìˆ˜ë„ nullë¡œ ì´ˆê¸°í™”) ---
        function resetMarkersAndPath() {
            if(startMarker) startMarker.setMap(null);
            if(endMarker) endMarker.setMap(null);
            if(polyline) polyline.setMap(null);
            
            obstacleMarkers.forEach(marker => marker.setMap(null));
            obstacleMarkers = []; 

            startMarker = null;
            endMarker = null;
            polyline = null;
        }
        
        function resetMap() {
            resetMarkersAndPath();
            document.getElementById('start_input').value = "";
            document.getElementById('end_input').value = "";
            document.getElementById('info_text').innerHTML = "ìƒˆ ê²½ë¡œ ì°¾ê¸° ì‹œì‘. í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            map.setCenter(new Tmapv2.LatLng(37.566535, 126.9779692)); 
            map.setZoom(15);
        }


        // --- ê²½ë¡œ ì°¾ê¸° (í…ìŠ¤íŠ¸ ì…ë ¥ ê¸°ë°˜ ë°±ì—”ë“œ í˜¸ì¶œ) ---
        function findPathFromInput() {
            var startText = document.getElementById('start_input').value;
            var endText = document.getElementById('end_input').value;

            if (!startText || !endText) {
                document.getElementById('info_text').innerHTML = "âŒ ì¶œë°œì§€ì™€ ë„ì°©ì§€ í‚¤ì›Œë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                return;
            }

            var postData = {
                start: startText, 
                end: endText      
            };

            document.getElementById('info_text').innerHTML = `"${startText}"ì—ì„œ "${endText}"ë¡œ ê²½ë¡œë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...`;
            resetMarkersAndPath(); 

            fetch("/api/route/", { 
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken 
                },
                body: JSON.stringify(postData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || errorData.details || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => drawLine(data))
            .catch(error => {
                console.error("Error:", error);
                document.getElementById('info_text').innerHTML = `âŒ ê²½ë¡œ íƒìƒ‰ ì‹¤íŒ¨: ${error.message}`;
            });
        }
        
        // --- ê²½ë¡œ ê·¸ë¦¬ê¸° ë° ì¥ì• ë¬¼ í‘œì‹œ (TMAP GeoJSON íŒŒì‹±) ---
        function drawLine(data) {
            var features = data.features;
            if (!features || features.length === 0) {
                alert("ê²½ë¡œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                document.getElementById('info_text').innerHTML = "âŒ ê²½ë¡œ íƒìƒ‰ ì‹¤íŒ¨. ë³´í–‰ ê°€ëŠ¥í•œ ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.";
                return; 
            }
            
            var pathPointList = [];
            var obstaclePoints = [];

            features.forEach(feature => {
                var geometry = feature.geometry;
                var properties = feature.properties;
                
                // 1. LineString (ê²½ë¡œ) ì¢Œí‘œ ì¶”ì¶œ
                if (geometry.type === "LineString" && geometry.coordinates) {
                    geometry.coordinates.forEach(coord => {
                        pathPointList.push(new Tmapv2.LatLng(coord[1], coord[0])); // [ìœ„ë„, ê²½ë„] ìˆœì„œë¡œ ë³€í™˜
                    });
                } 
                
                // 2. Point (ì•ˆë‚´/ì¥ì• ë¬¼) ì¢Œí‘œ ì¶”ì¶œ
                if (geometry.type === "Point" && geometry.coordinates) {
                    var description = properties.description || properties.name || properties.pointType;
                    
                    // ì¶œë°œ(12), ë„ì°©(11) ì§€ì  ë§ˆì»¤ëŠ” ë”°ë¡œ ì²˜ë¦¬
                    if (properties.pointType === "12") {
                        startMarker = new Tmapv2.Marker({
                            position: new Tmapv2.LatLng(geometry.coordinates[1], geometry.coordinates[0]),
                            map: map, title: "ì¶œë°œì§€", icon: createStartMarkerIcon(), iconSize: new Tmapv2.Size(50, 60)
                        });
                    } else if (properties.pointType === "11") {
                        endMarker = new Tmapv2.Marker({
                            position: new Tmapv2.LatLng(geometry.coordinates[1], geometry.coordinates[0]),
                            map: map, title: "ë„ì°©ì§€", icon: createEndMarkerIcon(), iconSize: new Tmapv2.Size(50, 60)
                        });
                    } else {
                        // ë‚˜ë¨¸ì§€ ì•ˆë‚´/ì¥ì• ë¬¼ í¬ì¸íŠ¸
                        obstaclePoints.push({
                            lon: geometry.coordinates[0],
                            lat: geometry.coordinates[1],
                            type: description 
                        });
                    }
                }
            });
            
            // ê²½ë¡œì„  ê·¸ë¦¬ê¸°
            polyline = new Tmapv2.Polyline({
                path: pathPointList, strokeColor: "#FF0000", strokeWeight: 6, map: map
            });
            
            // ì¥ì• ë¬¼ ë§ˆì»¤ ê·¸ë¦¬ê¸°
            obstaclePoints.forEach(obstacle => {
                var position = new Tmapv2.LatLng(obstacle.lat, obstacle.lon);
                var emoji = getMarkerEmoji(obstacle.type);
                var bgColor = getMarkerColor(obstacle.type);
                var icon = createEmojiIcon(emoji, bgColor);
                
                // ì¥ì• ë¬¼ ë§ˆì»¤ëŠ” obstacleMarkers ë°°ì—´ì— ì¶”ê°€í•˜ì—¬ ì´ˆê¸°í™” ì‹œ ëª¨ë‘ ì œê±°ë˜ë„ë¡ í•©ë‹ˆë‹¤.
                var marker = new Tmapv2.Marker({
                    position: position, map: map, title: obstacle.type || 'ì•ˆë‚´ ì§€ì ',
                    icon: icon, iconSize: new Tmapv2.Size(40, 40)
                });
                obstacleMarkers.push(marker);
            });
            
            // ì§€ë„ ì˜ì—­ ì„¤ì • ë° ìƒíƒœ ì—…ë°ì´íŠ¸
            if (pathPointList.length > 0) {
                map.fitBounds(new Tmapv2.LatLngBounds(pathPointList[0], pathPointList[pathPointList.length - 1]));
            }
            document.getElementById('info_text').innerHTML = `âœ… ê²½ë¡œ ì™„ë£Œ!<br>ì•ˆë‚´ ì§€ì  ${obstaclePoints.length}ê°œ í‘œì‹œ.`;
        }
    </script>
</body>
</html>